let e;const r=require("fs"),o=require("node-fetch"),t=require("chalk"),n=require("adm-zip"),a={},i={};updated=[];const c=e=>r.readdirSync(e,{withFileTypes:!0}).filter((e=>!e.isDirectory())).map((e=>e.name));function s(){r.rmSync("./cache/",{recursive:!0,force:!0}),setTimeout((()=>{}),5e3)}console.error=e=>{try{process.stdout.write("")}catch(e){console.log("")}console.log(t.white.bgRed(e))},c("./").includes("automate.js")?r.readFile("./versions.json","utf8",(function(o,t){if(o)throw o;e=JSON.parse(t),function(){let e="./cache/";try{r.mkdirSync(e)}catch(o){r.rmSync(e,{recursive:!0,force:!0}),r.mkdirSync(e)}function o(){if(0!=updated.length){var e=require("shelljs");console.green("running git!"),e.exec(`cd .. && git add . && git commit -m "this commit is automated! ${updated.join(", ")}" && git push`),console.green("DONE!!!"),s()}else console.green("\nNo updates!"),s()}p.armaInit((()=>p.armaFormat((()=>p.suborgInit((()=>p.suborgFormat((()=>p.aleInit((()=>p.aleFormat((()=>o()))))))))))))}()})):console.error("RUN THE SCRIPT INSIDE THE NODE FOLDER"),console.green=e=>{console.log(t.black.bgGreenBright(e))};let l=["bakabakaplayer"];const p={};(()=>{const n=require("compare-versions");let s=0;function f(e,r){if(0==s){l=[];let o="arma7x"==e?"":"\n";console.log(t.black[r](o+`Checking versions of ${e}'s apps...`))}}function b(e,r){console.error(`error app check ver: ${e} => `+r)}function v(e){console.log(`start init: ${e}`)}p.armaInit=r=>{f("arma7x","bgYellow");const o=Object.keys(e.arma7x),t=o[s],a=()=>{if(s++,s==o.length)return console.green("Done checking for updates! => "+JSON.stringify(l)),s=0,void(null!=r&&r());p.armaInit(r)};g(t,(r=>{n(e.arma7x[t],r)<0?(console.log(`new ver: ${t} = ${e.arma7x[t]} -> ${r}`),l.push(t),a()):a()}),(e=>{b(t,e),a()}))},p.armaFormat=o=>{if(0==l.length)return void(o&&o());var n;n="arma7x",0==s&&console.log(t.white.bgBlue(`\nUpdating ${n}'s apps...`));let a=l[s],i={atm:"pocket-atm","k file":"b2gfm","k-pocket":"K-Pocket-Browser","k-music":"kaimusic",todoist:"k-todoist",mdx:"kai-mdx-dictionary","k-video":"k-video-player","the economy":"The-Economy",habit:"kai-habit-tracker"}[a],m=`./cache/${i}-master/`,f=()=>{if(s++,s==l.length)return console.green("Done updating arma7x's apps!!!"),y(),s=0,void(null!=o&&o());p.armaFormat(o)},b=e=>{console.error(e),f()};v(i),d(`https://github.com/arma7x/${i}/archive/refs/heads/master.zip`,"./cache/master.zip").then((()=>{u((()=>{let o=!1,t=!1;if(c(m).forEach((e=>{/zip|application|kaiads|webmanifest|gitignore|README/s.test(e)&&r.rmSync(m+e,{recursive:!0,force:!0}),/app\.js|index\.html/s.test(e)&&("app.js"==e&&(o=!0),function(o){let t=r.readFileSync(m+e,"utf-8"),n=!0===o?t.replaceAll("function displayKaiAds()","function regexVeryDumb()").replaceAll("displayKaiAds();",""):t.replaceAll('<script src="/kaiads.v5.min.js"><\/script>',"");r.writeFileSync(m+e,n,"utf-8"),o&&console.log(`ads removed: ${i}`)}("index.html"!==e)),"manifest.webapp"==e&&(t=!0)})),"kaimusic"==i){let e=m+"assets/js/app.js",t=r.readFileSync(e,"utf-8");r.writeFileSync(e,t.replaceAll("function displayKaiAds()","function regexVeryDumb()").replaceAll("displayKaiAds();",""),"utf-8"),console.log(`ads removed: ${i}`),o=!0}o||console.error("arma7x's app.js was not found, ads will still be present"),t||console.error("manifest.webapp not found!"),h(m,(()=>{let o="./cache/";c(o).forEach((e=>{r.copyFileSync(o+e,`../arma7x/${a}/`+e),r.rmSync(o+e,{recursive:!0,force:!0})})),g(a,(r=>{updated.push(`${i} = ${e.arma7x[a]} => ${r}`),e.arma7x[a]=r})),console.log("done updating: "+i),f()}),(e=>b(e)),"arma7x/"+a)}),(e=>b(e)))})).catch((e=>b(e)))},p.aleInit=r=>{f("ale4710","bgRed");const t=Object.keys(e.ale4710),n=()=>{s==t.length&&(console.green("Done checking for updates! =>"+JSON.stringify(l)),s=0,null!=r&&r())};t.forEach((r=>{o(`https://alego.web.fc2.com/kaiosapps/${r}/changelog.txt`).then((e=>e.text())).then((o=>{s++;let t=o.split("\n")[0].split(" ")[0],i=e.ale4710[r];t!=i&&(/....-..-../s.test(t)?(console.log(`new ver: ${r} = ${i} -> ${t}`),a[r]=t,l.push(r)):b(r,"err: VERSION NUMBER IS WRONG")),n()})).catch((e=>{b(r,e),s++,n()}))}))},p.aleFormat=t=>{if(0==l.length)return void(t&&t());let n=l[s],i=()=>{if(s++,s==l.length)return console.green("Done updating ale4710's apps!!!"),y(),s=0,void(null!=t&&t());p.aleFormat(t)},f=e=>{console.error(e),i()},g=`https://alego.web.fc2.com/kaiosapps/${n}/`;o(g).then((e=>e.text())).then((o=>{let t=o.match(/<a[\s]+[^>]+(?:.(?!\<\/a\>))*.<\/a>/gi).find((e=>/source code|application/i.test(e))).match(/href="(.*?)"/i)[1],s=(l=t.split("."))[l.length-1];var l;let p="./cache/temp/";try{r.mkdirSync(p)}catch(e){r.rmSync(p,{recursive:!0,force:!0}),r.mkdirSync(p)}v(n),d(g+t,"./cache/master."+s).then((()=>{function o(){let o=!1;c(p).forEach((e=>{/kaiad/s.test(e)&&r.rmSync(p+e,{recursive:!0,force:!0}),"manifest.webapp"==e&&(o=!0)})),o||console.error("manifest.webapp not found!"),h(p,(()=>{let o="./cache/";c(o).forEach((e=>{r.copyFileSync(o+e,`../ale4710/${n}/`+e),r.rmSync(o+e,{recursive:!0,force:!0})})),updated.push(`${n} = ${e.ale4710[n]} => ${a[n]}`),e.ale4710[n]=a[n],console.log("done updating: "+n),i()}),(e=>f(e)),"ale4710/"+n)}"zip"==s?u(o,(e=>f(e)),p):"7z"==s?m(o,(e=>f(e))):f("suffix not 7z or zip hmmm")}))})).catch((e=>f(e)))},p.suborgInit=r=>{f("suborg","bgGreen");const t=Object.keys(e.suborg);t.forEach((a=>{o(`https://gitlab.com/suborg/${a}/-/raw/${"crosstweak"==a?"main":"master"}/manifest.webapp`).then((e=>e.json())).then((o=>{s++;let c=o.version,p=e.suborg[a];n(p,c)<0&&(console.log(`new ver: ${a} = ${p} -> ${c}`),i[a]=c,l.push(a)),s==t.length&&(console.green("Done checking for updates! => "+JSON.stringify(l)),s=0,null!=r&&r())}))}))},p.suborgFormat=o=>{if(0==l.length)return void(o&&o());let t=l[s],n="crosstweak"==t?"main":"master",a=`./cache/${t}-${n}/`,m=()=>{if(s++,s==l.length)return console.green("Done updating suborg's apps!!!"),y(),s=0,void(null!=o&&o());p.suborgFormat(o)},f=e=>{console.error(e),m()};v(t),d(`https://gitlab.com/suborg/${t}/-/archive/${n}/${t}-${n}.zip`,"./cache/master.zip").then((()=>{u((()=>{let o=!1;c(a).forEach((e=>{/zip|application|\.sh|webmanifest|gitignore|README/s.test(e)&&r.rmSync(a+e,{recursive:!0,force:!0}),"manifest.webapp"==e&&(o=!0)})),o||console.error("manifest.webapp not found!"),h(a,(()=>{let o="./cache/";c(o).forEach((e=>{r.copyFileSync(o+e,`../suborg/${t}/`+e),r.rmSync(o+e,{recursive:!0,force:!0})})),updated.push(`${t} = ${e.suborg[t]} => ${i[t]}`),e.suborg[t]=i[t],console.log("done updating: "+t),m()}),(e=>f(e)),"suborg/"+t)}),(e=>f(e)))})).catch((e=>f(e)))}})();const u=(e,o,t)=>{let a="./cache/master.zip",i="./cache/";t&&(i=t);try{var c=new n(a);c.extractAllTo(i,!0),r.rmSync(a,{recursive:!0,force:!0}),c=null}catch(e){return void(null!=o&&o(e))}null!=e&&e()},m=(e,r,o)=>{let t="./cache/temp/";o&&(t=o),require("7zip-min").unpack("./cache/master.7z",t,(o=>{null!=o?r(o):e()}))},h=(e,o,t,a)=>{try{(i=new n).addLocalFolder(e);var i,c=i.toBuffer();(i=new n).addFile("application.zip",c),i.addFile("metadata.json",Buffer.from(`{"version": 1,"manifestURL":"${function(e){let r=a.split("/");return r[1]=encodeURIComponent(r[1]),`https://raw.githubusercontent.com/cyan-2048/_store/main/${r.join("/")}/manifest.webapp`}()}"}\n`,"utf8")),i.writeZip(`./cache/${a.split("/")[1]}.zip`),r.copyFileSync(e+"manifest.webapp","./cache/manifest.webapp"),i=null,r.rmSync(e,{recursive:!0,force:!0})}catch(e){return void(null!=t&&t(e))}null!=o&&o()},d=async(e,t)=>{const n=await o(e),a=r.createWriteStream(t);await new Promise(((e,r)=>{n.body.pipe(a),n.body.on("error",r),a.on("finish",e)}))};let f=null;function g(e,r,o){function t(t){let n=t.apps.find((r=>r.display.toLowerCase().includes(e)));if(void 0!==n)void 0!==r&&r(n.version);else{let e="Error: APP NOT FOUND!";console.error(e),null!=o&&o(e)}}if(null!==f)return void t(f);new(require("./kaistone-requester"))({method:"api-key",key:"baJ_nea27HqSskijhZlT"},{app:{id:"CAlTn_6yQsgyJKrr-nCh",name:"KaiOS Plus",ver:"2.5.4"},server:{url:"https://api.kaiostech.com"},ver:"3.0"},{model:"GoFlip2",imei:"123456789012345",type:999999,brand:"AlcatelOneTouch",os:"KaiOS",version:"2.5.4",ua:"Mozilla/5.0 (Mobile; GoFlip2; rv:48.0) Gecko/48.0 Firefox/48.0 KAIOS/2.5.4",cu:"4044O-2BAQUS1-R",mcc:"0",mnc:"0"},(e=>{throw null!=o&&o(e),e}),(function(){this.send({method:"GET",path:"/kc_ksfe/v1.0/apps?os=2.5.4&mcc=null&mnc=null&bookmark=false",type:"json"}).then((e=>{f=e,t(e)}))}))}function y(){r.writeFileSync("./versions.json",JSON.stringify(e,null,"\t"),"utf-8")}